<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[練習] GitLab CI/CD | 羲加加的部落格</title>
<meta name=keywords content="Kdan,Android,Gitlab,CI/CD"><meta name=description content="Kdan Android Team 實習作業"><meta name=author content="CPP"><link rel=canonical href=http://localhost:1313/posts/2023-08-29-kdan-gitlab-ci-cd/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/2023-08-29-kdan-gitlab-ci-cd/><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6136142817575418" crossorigin=anonymous></script><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[練習] GitLab CI/CD"><meta property="og:description" content="Kdan Android Team 實習作業"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/2023-08-29-kdan-gitlab-ci-cd/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-29T22:26:13+08:00"><meta property="article:modified_time" content="2023-08-29T22:26:13+08:00"><meta property="og:site_name" content="羲加加的部落格"><meta name=twitter:card content="summary"><meta name=twitter:title content="[練習] GitLab CI/CD"><meta name=twitter:description content="Kdan Android Team 實習作業"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"[練習] GitLab CI/CD","item":"http://localhost:1313/posts/2023-08-29-kdan-gitlab-ci-cd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[練習] GitLab CI/CD","name":"[練習] GitLab CI\/CD","description":"Kdan Android Team 實習作業","keywords":["Kdan","Android","Gitlab","CI/CD"],"articleBody":"GitLab CI/CD 練習 前言 這是我 Android 實習的第一份作業，為了讓我的主管們知道我理解的程度，記錄一下學習的過程～\n任務清單 1. 使用 Android Studio 創建一個 ”Hello World!” 專案 2. 試著在該專案寫一個 Unit Test (Java Test)，並成功執行測試 3. 試著在該專案寫一個執行 androidTest，並成功執行測試 4. 在 GitLab 上新增該專案的 Repository 5. 嘗試在 Windows 或是 MacOS 或是 Linux 上架設 GitLabRunner (三擇一) 6. 再嘗試使用架設 GitLab Runner 在 Docker container 之中 7. 然後將架設好的 GitLab Runner 註冊至題目 4 的 GitLab Repository 8. 研究 yml 檔案如何撰寫及其中所代表的意義 CI / CD 簡介 一個軟體開發後，需要經過很多個測試，可能還需要維護，為了讓開發團隊以及維護團隊能夠更快、有效率的運作，產生出一個 DevOps （Development \u0026 Operations）的概念。它算是一個慣例，更準確來說是一種規範，而 CI/CD 就是其中的一個環節! https://orangematter.solarwinds.com/wp-content/uploads/2022/03/DevOps-lifecycle-capabilities-1024x621.png\nCI Continuous Integration 持續整合，通常是讓程式能夠 build 以及 test\nCD Continuous Deploy / Development 持續部署，讓這些程式能夠依照我們想要的環境部署\nWhy 就以測試來講每寫一個 test code，就要跑一遍，這樣太沒效率了，如果可以把它自動化就會變得非常方便，所以 CI/CD 就顯得非常重要。\n我們可以利用一些 lint 檢查 code 的語法或是風格使它們一致；也可以建立虛擬環境讓它在產品階段部署，把這些產品的產線自動化後，後續的維護會節省很多的人力成本，而且也可以把每一個步驟拆分給更專業的人員，這就是它的精神！\n以下會用 Gitlab 來實作簡單的 CI！\n撰寫測試 Android 的測試分兩種：test、androidTest，與平常寫程式的地方 main 在同一層目錄 簡單寫一個 HelloWorld 的類別，以利後面進行測試\npackage com.cppdesign.helloworld class HelloWorld(private val name: String) { override fun toString(): String { return \"Hello, $name!\" } } 這裡使用 Kotlin，後續 test 都用 Java\ntest test 包含 UnitTest 驗證邏輯與功能（Model 的 function 之類的） 在 local 的 JVM(Java Virtual Machine) 跑 需要 import Junit 的類別，以及需要的 Assert functions\npackage com.cppdesign.helloworld; import org.junit.Test; import static org.junit.Assert.assertEquals; public class HelloWorldUnitTest { private HelloWorld helloWorld; @Test public void toString_correct() { helloWorld = new HelloWorld(\"Steven\"); assertEquals(\"Hello, Steven!\", helloWorld.toString()); } // it must be fail because the sentence is missing one symbol (!) @Test public void toString_fail() { helloWorld = new HelloWorld(\"Steven\"); assertEquals(\"Hello, Steven\", helloWorld.toString()); } } 上述函式在進行測試時，會有一個成功、一個失敗（少一個 !）\nandroidTest androidTest 包含 InstrumentedTest 會需要在模擬器或是實體裝置上運行 通常驗證整體行為與 Android 平台的互動 不確定要測試什麼，所以就學 ExampleInstrumentedTest.kt\npackage com.cppdesign.helloworld; import org.junit.Before; import org.junit.Test; import static org.junit.Assert.assertEquals; import android.content.Context; import androidx.test.platform.app.InstrumentationRegistry; public class HelloWorldInstrumentedTest { Context appContext; @Before public void createInstrumentationRegistry() { appContext = InstrumentationRegistry.getInstrumentation().getTargetContext(); } @Test public void useAppName() { assertEquals(\"Hello World!\", appContext.getApplicationInfo().loadLabel(appContext.getPackageManager()).toString()); } @Test public void useAppNameFail() { assertEquals(\"Hello, World!\", appContext.getApplicationInfo().loadLabel(appContext.getPackageManager()).toString()); } } 利用 @Before 把會用到的的變數實體化。一樣會一成功、一失敗（多了 !）\nGitlab 介紹 因為自己都使用 Github 託管程式碼，第一次接觸到 Gitlab 發現很多地方很相似，所以記錄一些都會用到的功能以及名詞\n名詞比較 Gitlab / Github\nproject / repository ci / action group / organization 連接方式 它也跟 Github 一樣提供了 SSH 與 PAT 的功能，讓讀取更方便，可以不用打密碼登入帳號\nSSH Key 從頭像點進去 Edit profile (User settings) \u003e SSH Keys Personal Access Token 這功能在 Github 裡是可以在 Android Studio 操作相關 repo，但是我在 AS 裡找不到 Gitlab 的選項，所以只好寫起來放\n跟 SSH Keys 同一層，要點 Access Tokens\nAndroid Studio VCS VCS(Version Control System) 是 AS 提供版本控制的系統，一開始要把 VCS 打開，但因為找不到 Gitlab 的選項，所以只能手動加入 remote\n利用 token 連接 Project 可以不用打帳密登入 紅色部分為 token\n在 push 前，把 branch 名稱改成 main 因為平權意識抬頭，現在 branch 提倡用 main/others 命名方式\n上傳程式碼 這部分就是一系列的 git 操作，沒有什麼差別\nWorkflow https://about.gitlab.com/images/gitlab-flow/gitlab-flow.svg\nGitlab flow 就與 Git flow 有差別了，想知道更多可以看這部影片 GitLab CI 實作 這次用 Gitlab 主要是使用它的 CI 功能，不像 Github Actions 有很多套件可以選擇，反而需要自己寫 workflow 還有建製 runner\n名詞介紹 https://www.opengeosys.org/docs/devguide/testing/gitlab-ci/GitLab-Pipeline.png\nPipelines 上圖一整個畫面就是一個 pipeline，在 Gitlab 中的 pipeline 與 CPU pipeline 相似，目的都是讓程式能夠更快的執行完畢，在這裡是為了讓我們的 CI 各方便快速。\nStages 最上面那一列的粗體黑字就是 stage，代表這一個 pipeline 的各個階段，Gitlab 的官方文件有簡易的寫法，也可以自定義。\nJobs stage 裡面每一個方框就是 job，代表它的工作，實際上要做什麼事都在裡面定義\nRunners 這些 jobs 需要架機器在上面跑，這時候就需要 runner\n在 Gitlab 中分成這三種： shared runner group runner project runner .gitlab-ci.yml 上述說到 Gitlab CI 非常的客製化，可以自定義 pipeline，而這些檔案就需要寫在 .gitlab-ci.yml\n. 指在目錄中預設隱藏（不會顯示），與 .gitignore 一樣 gitlab-ci 是 Gitlab 的預設檔名，會自動加入 pipeline yml 是一種標籤語言（YAML Ain’t a Markup Language），常用來記錄設定檔（configuration） 這是官方文件的設定檔範例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 build-job: stage: build script: - echo \"Hello, $GITLAB_USER_LOGIN!\" test-job1: stage: test script: - echo \"This job tests something\" test-job2: stage: test script: - echo \"This job tests something, but takes more time than test-job1.\" - echo \"After the echo commands complete, it runs the sleep command for 20 seconds\" - echo \"which simulates a test that runs 20 seconds longer than test-job1\" - sleep 20 deploy-prod: stage: deploy script: - echo \"This job deploys something from the $CI_COMMIT_BRANCH branch.\" environment: production 一般來說會有以下 stages：\nbuild test staging production stages 標籤是記錄各種階段，對應到每個 job 裡面的 stage（line 2, 7, 12, 20） jobs 的名稱沒有硬性規定，就像變數命名一樣（line 1, 6, 11, 19） script 就跟 shell script 很像，可以執行一些指令（line 3, 8, 13, 21） 官方文件還有很多關鍵字參考\nAssigned Runner 寫完設定檔之後，再來就要架設 runner，規則大概如下：\n新建 runner 在 project 裡面點進 Settings \u003e CI/CD \u003e Runners \u003e 點進 Expand 左右邊分成兩種 runner：\nproject runner shared runner (credit card validate) 第二種 shared runner 是官方提供的 runner，但是需要信用卡認證（不用錢），但自己還是有疑慮就沒試了\n點進 project runners \u003e new project runner 填寫 Operating System、Tags、Details，就可以 Create runner 了\n在 Tags 下有一個 checkbox 建議勾選（當初沒勾選卡了很久）\n安裝 gitlab-runner 在註冊 runner 前，需要在自己的機器上建立環境，分成兩種：\nlocal runner （很麻煩） docker （推薦用這個） 安裝記錄就不寫了，放幾個當時遇到問題的圖片以及 references： Change Gitlab CI Runner user Registering runners 主要是權限環境問題，所以很推薦直接用 docker 建立虛擬環境，會它的基本指令直接照文件下就好了\n註冊 runner 建立完 runner 後再來就是 register，這步驟就像是你的 repo 與你電腦裡的 runner 連接\n紅色部分為 token，每個 runner 的 token 都是唯一的\n接著照著下指令寫 runner 的設定檔（config.toml）：\nINSTANCE URL （你的 repo 的前綴網址） 詳情看這裡\ntoken name (Description) executor 它有很多種可以選，如果 runner 架在 local，想直接跑 .gitlab-ci.yml 選擇 shell 就好；用 docker 架設的話就選 docker\n這個設定檔預設放在 /etc/gitlab-runner 因為每建一個 runner 都要再設定一次 config，也不可能改 config 位置，所以用 docker 建 runner 真的很方便\n執行 runner 再來就是 run runner 了\nlocal 端就下\n$ gitlab-runner run docker 就用 image 建立實例\n$ docker run --rm -it -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register 結果 到 Project 裡的 Build \u003e Pipelines，可以看到這個 pipeline 的運行結果 如果看到左邊的 Status 一直在 pending 可能是你的 runner 沒打開\n心得 Gitlab CI 的自由度好高，感覺可以把很多後續維護的步驟全部自動化。而且後來研究過程中才發現我用過 Github Actions 它也是 CI 的一種，我這個部落格的架設就是利用它！\n因為我的 code 沒有太龐大，所以沒有寫到 auto test，只有簡單的 echo，希望之後可以學到更多～\n相關連結 Gitlab Project - Steven Ye / Hello World Github Actions - qaz5823091.github.io 參考 Build local unit tests Build instrumented tests Continuous Integration with GitLab (overview demo) GitLab Runner Install GitLab Runner 架設 GitLab CI Runner What Is GitLab Workflow | GitLab Flow | GitLab Tutorial For Beginners | Part III 別怕！.gitlab-ci.yml 勇敢寫下去！ .gitlab-ci.yml keyword reference Gitlab CI/CD 介紹與 Runner 的架設 CI/CD pipelines https://linyencheng.github.io/2022/05/30/devops-gitlab-ci-and-gitlab-runner/ Tutorial: Create and run your first GitLab CI/CD pipeline Gitlab instance URL Android GitLab CI + Docker 工程实践 Change Gitlab CI Runner user Pipelines jobs without tag Registering runners Docker part Run GitLab Runner in a container ","wordCount":"861","inLanguage":"en","datePublished":"2023-08-29T22:26:13+08:00","dateModified":"2023-08-29T22:26:13+08:00","author":{"@type":"Person","name":"CPP"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2023-08-29-kdan-gitlab-ci-cd/"},"publisher":{"@type":"Organization","name":"羲加加的部落格","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="羲加加的部落格 (Alt + H)">羲加加的部落格</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=http://localhost:1313/archives/ title=Archives><span>Archives</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">[練習] GitLab CI/CD</h1><div class=post-meta><span title='2023-08-29 22:26:13 +0800 CST'>August 29, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;CPP</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#gitlab-cicd-%e7%b7%b4%e7%bf%92 aria-label="GitLab CI/CD 練習">GitLab CI/CD 練習</a><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e4%bb%bb%e5%8b%99%e6%b8%85%e5%96%ae aria-label=任務清單>任務清單</a></li><li><a href=#ci--cd-%e7%b0%a1%e4%bb%8b aria-label="CI / CD 簡介">CI / CD 簡介</a><ul><li><a href=#ci aria-label=CI>CI</a></li><li><a href=#cd aria-label=CD>CD</a></li><li><a href=#why aria-label=Why>Why</a></li></ul></li><li><a href=#%e6%92%b0%e5%af%ab%e6%b8%ac%e8%a9%a6 aria-label=撰寫測試>撰寫測試</a><ul><li><a href=#test aria-label=test>test</a></li><li><a href=#androidtest aria-label=androidTest>androidTest</a></li></ul></li><li><a href=#gitlab-%e4%bb%8b%e7%b4%b9 aria-label="Gitlab 介紹">Gitlab 介紹</a><ul><li><a href=#%e5%90%8d%e8%a9%9e%e6%af%94%e8%bc%83 aria-label=名詞比較>名詞比較</a></li><li><a href=#%e9%80%a3%e6%8e%a5%e6%96%b9%e5%bc%8f aria-label=連接方式>連接方式</a><ul><li><a href=#ssh-key aria-label="SSH Key">SSH Key</a></li><li><a href=#personal-access-token aria-label="Personal Access Token">Personal Access Token</a></li></ul></li><li><a href=#android-studio-vcs aria-label="Android Studio VCS">Android Studio VCS</a></li><li><a href=#%e4%b8%8a%e5%82%b3%e7%a8%8b%e5%bc%8f%e7%a2%bc aria-label=上傳程式碼>上傳程式碼</a></li></ul></li><li><a href=#workflow aria-label=Workflow>Workflow</a></li><li><a href=#gitlab-ci-%e5%af%a6%e4%bd%9c aria-label="GitLab CI 實作">GitLab CI 實作</a><ul><li><a href=#%e5%90%8d%e8%a9%9e%e4%bb%8b%e7%b4%b9 aria-label=名詞介紹>名詞介紹</a><ul><li><a href=#pipelines aria-label=Pipelines>Pipelines</a></li><li><a href=#stages aria-label=Stages>Stages</a></li><li><a href=#jobs aria-label=Jobs>Jobs</a></li><li><a href=#runners aria-label=Runners>Runners</a></li></ul></li><li><a href=#gitlab-ciyml aria-label=.gitlab-ci.yml>.gitlab-ci.yml</a></li><li><a href=#assigned-runner aria-label="Assigned Runner">Assigned Runner</a><ul><li><a href=#%e6%96%b0%e5%bb%ba-runner aria-label="新建 runner">新建 runner</a></li><li><a href=#%e5%ae%89%e8%a3%9d-gitlab-runner aria-label="安裝 gitlab-runner">安裝 gitlab-runner</a></li><li><a href=#%e8%a8%bb%e5%86%8a-runner aria-label="註冊 runner">註冊 runner</a></li><li><a href=#%e5%9f%b7%e8%a1%8c-runner aria-label="執行 runner">執行 runner</a></li></ul></li><li><a href=#%e7%b5%90%e6%9e%9c aria-label=結果>結果</a></li></ul></li><li><a href=#%e5%bf%83%e5%be%97 aria-label=心得>心得</a></li><li><a href=#%e7%9b%b8%e9%97%9c%e9%80%a3%e7%b5%90 aria-label=相關連結>相關連結</a></li><li><a href=#%e5%8f%83%e8%80%83 aria-label=參考>參考</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=gitlab-cicd-練習>GitLab CI/CD 練習<a hidden class=anchor aria-hidden=true href=#gitlab-cicd-練習>#</a></h1><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>這是我 Android 實習的第一份作業，為了讓我的主管們知道我理解的程度，記錄一下學習的過程～</p><h2 id=任務清單>任務清單<a hidden class=anchor aria-hidden=true href=#任務清單>#</a></h2><ul><li><input checked disabled type=checkbox> 1. 使用 Android Studio 創建一個 ”Hello World!” 專案</li><li><input checked disabled type=checkbox> 2. 試著在該專案寫一個 Unit Test (Java Test)，並成功執行測試</li><li><input checked disabled type=checkbox> 3. 試著在該專案寫一個執行 androidTest，並成功執行測試</li><li><input checked disabled type=checkbox> 4. 在 GitLab 上新增該專案的 Repository</li><li><input checked disabled type=checkbox> 5. 嘗試在 Windows 或是 MacOS 或是 Linux 上架設 GitLabRunner (三擇一)</li><li><input checked disabled type=checkbox> 6. 再嘗試使用架設 GitLab Runner 在 Docker container 之中</li><li><input checked disabled type=checkbox> 7. 然後將架設好的 GitLab Runner 註冊至題目 4 的 GitLab Repository</li><li><input checked disabled type=checkbox> 8. 研究 yml 檔案如何撰寫及其中所代表的意義</li></ul><h2 id=ci--cd-簡介>CI / CD 簡介<a hidden class=anchor aria-hidden=true href=#ci--cd-簡介>#</a></h2><p>一個軟體開發後，需要經過很多個測試，可能還需要維護，為了讓開發團隊以及維護團隊能夠更快、有效率的運作，產生出一個 DevOps （Development & Operations）的概念。它算是一個慣例，更準確來說是一種規範，而 CI/CD 就是其中的一個環節!
<img loading=lazy src=https://orangematter.solarwinds.com/wp-content/uploads/2022/03/DevOps-lifecycle-capabilities-1024x621.png alt=demo></p><blockquote><p><a href=https://orangematter.solarwinds.com/wp-content/uploads/2022/03/DevOps-lifecycle-capabilities-1024x621.png>https://orangematter.solarwinds.com/wp-content/uploads/2022/03/DevOps-lifecycle-capabilities-1024x621.png</a></p></blockquote><h3 id=ci>CI<a hidden class=anchor aria-hidden=true href=#ci>#</a></h3><p>Continuous Integration 持續整合，通常是讓程式能夠 build 以及 test</p><h3 id=cd>CD<a hidden class=anchor aria-hidden=true href=#cd>#</a></h3><p>Continuous Deploy / Development 持續部署，讓這些程式能夠依照我們想要的環境部署</p><h3 id=why>Why<a hidden class=anchor aria-hidden=true href=#why>#</a></h3><p>就以測試來講每寫一個 test code，就要跑一遍，這樣太沒效率了，如果可以把它自動化就會變得非常方便，所以 CI/CD 就顯得非常重要。</p><p>我們可以利用一些 <code>lint</code> 檢查 code 的語法或是風格使它們一致；也可以建立<code>虛擬環境</code>讓它在產品階段部署，把這些產品的產線自動化後，後續的維護會節省很多的人力成本，而且也可以把每一個步驟拆分給更專業的人員，這就是它的精神！</p><p>以下會用 <code>Gitlab</code> 來實作簡單的 CI！</p><h2 id=撰寫測試>撰寫測試<a hidden class=anchor aria-hidden=true href=#撰寫測試>#</a></h2><p>Android 的測試分兩種：test、androidTest，與平常寫程式的地方 <code>main</code> 在同一層目錄
<img loading=lazy src=/images/android_test_directory.png alt=demo></p><p>簡單寫一個 <code>HelloWorld</code> 的類別，以利後面進行測試</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>package</span> com.cppdesign.helloworld
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorld</span>(<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> name: String) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>toString</span>(): String {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello, </span><span style=color:#e6db74>$name</span><span style=color:#e6db74>!&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>這裡使用 <code>Kotlin</code>，後續 test 都用 <code>Java</code></p></blockquote><h3 id=test>test<a hidden class=anchor aria-hidden=true href=#test>#</a></h3><ul><li>test 包含 <code>UnitTest</code></li><li>驗證邏輯與功能（Model 的 function 之類的）</li><li>在 local 的 JVM(Java Virtual Machine) 跑</li></ul><blockquote><p>需要 import <code>Junit</code> 的類別，以及需要的 <code>Assert</code> functions</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.cppdesign.helloworld;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.junit.Assert.assertEquals;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorldUnitTest</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> HelloWorld helloWorld;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>toString_correct</span>() {
</span></span><span style=display:flex><span>        helloWorld <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloWorld(<span style=color:#e6db74>&#34;Steven&#34;</span>);
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;Hello, Steven!&#34;</span>, helloWorld.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// it must be fail because the sentence is missing one symbol (!)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>toString_fail</span>() {
</span></span><span style=display:flex><span>        helloWorld <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HelloWorld(<span style=color:#e6db74>&#34;Steven&#34;</span>);
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;Hello, Steven&#34;</span>, helloWorld.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>上述函式在進行測試時，會有一個成功、一個失敗（少一個 <code>!</code>）</p></blockquote><h3 id=androidtest>androidTest<a hidden class=anchor aria-hidden=true href=#androidtest>#</a></h3><ul><li>androidTest 包含 <code>InstrumentedTest</code></li><li>會需要在模擬器或是實體裝置上運行</li><li>通常驗證整體行為與 Android 平台的互動</li></ul><blockquote><p>不確定要測試什麼，所以就學 <code>ExampleInstrumentedTest.kt</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.cppdesign.helloworld;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.Before;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.junit.Test;
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.junit.Assert.assertEquals;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> android.content.Context;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> androidx.test.platform.app.InstrumentationRegistry;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloWorldInstrumentedTest</span> {
</span></span><span style=display:flex><span>    Context appContext;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Before</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createInstrumentationRegistry</span>() {
</span></span><span style=display:flex><span>        appContext <span style=color:#f92672>=</span> InstrumentationRegistry.<span style=color:#a6e22e>getInstrumentation</span>().<span style=color:#a6e22e>getTargetContext</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>useAppName</span>() {
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;Hello World!&#34;</span>, appContext.<span style=color:#a6e22e>getApplicationInfo</span>().<span style=color:#a6e22e>loadLabel</span>(appContext.<span style=color:#a6e22e>getPackageManager</span>()).<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>useAppNameFail</span>() {
</span></span><span style=display:flex><span>        assertEquals(<span style=color:#e6db74>&#34;Hello, World!&#34;</span>, appContext.<span style=color:#a6e22e>getApplicationInfo</span>().<span style=color:#a6e22e>loadLabel</span>(appContext.<span style=color:#a6e22e>getPackageManager</span>()).<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>利用 <code>@Before</code> 把會用到的的變數實體化。一樣會一成功、一失敗（多了 <code>!</code>）</p></blockquote><h2 id=gitlab-介紹>Gitlab 介紹<a hidden class=anchor aria-hidden=true href=#gitlab-介紹>#</a></h2><p>因為自己都使用 <code>Github</code> 託管程式碼，第一次接觸到 <code>Gitlab</code> 發現很多地方很相似，所以記錄一些都會用到的功能以及名詞</p><h3 id=名詞比較>名詞比較<a hidden class=anchor aria-hidden=true href=#名詞比較>#</a></h3><p>Gitlab / Github</p><ul><li>project / repository</li><li>ci / action</li><li>group / organization</li></ul><h3 id=連接方式>連接方式<a hidden class=anchor aria-hidden=true href=#連接方式>#</a></h3><p>它也跟 <code>Github</code> 一樣提供了 <code>SSH</code> 與 <code>PAT</code> 的功能，讓讀取更方便，可以不用打密碼登入帳號</p><h4 id=ssh-key>SSH Key<a hidden class=anchor aria-hidden=true href=#ssh-key>#</a></h4><p>從頭像點進去 <code>Edit profile</code> (<code>User settings</code>) > <code>SSH Keys</code>
<img loading=lazy src=/images/gitlab_ssh_key.png alt=demo></p><h4 id=personal-access-token>Personal Access Token<a hidden class=anchor aria-hidden=true href=#personal-access-token>#</a></h4><p>這功能在 <code>Github</code> 裡是可以在 <code>Android Studio</code> 操作相關 <code>repo</code>，但是我在 AS 裡找不到 <code>Gitlab</code> 的選項，所以只好寫起來放</p><p><img loading=lazy src=/images/gitlab_pat.png alt=demo></p><blockquote><p>跟 SSH Keys 同一層，要點 <code>Access Tokens</code></p></blockquote><h3 id=android-studio-vcs>Android Studio VCS<a hidden class=anchor aria-hidden=true href=#android-studio-vcs>#</a></h3><p>VCS(Version Control System) 是 AS 提供版本控制的系統，一開始要把 VCS 打開，但因為找不到 <code>Gitlab</code> 的選項，所以只能手動加入 <code>remote</code></p><ul><li><p>利用 <code>token</code> 連接 Project 可以不用打帳密登入
<img loading=lazy src=/images/vcs_1.png alt=demo></p><blockquote><p>紅色部分為 token</p></blockquote></li><li><p>在 <code>push</code> 前，把 branch 名稱改成 <code>main</code>
<img loading=lazy src=/images/vcs_2.png alt=demo></p><blockquote><p>因為平權意識抬頭，現在 branch 提倡用 main/others 命名方式</p></blockquote></li></ul><h3 id=上傳程式碼>上傳程式碼<a hidden class=anchor aria-hidden=true href=#上傳程式碼>#</a></h3><p>這部分就是一系列的 <code>git</code> 操作，沒有什麼差別</p><p><img loading=lazy src=/images/gitlab_project.png alt=demo></p><h2 id=workflow>Workflow<a hidden class=anchor aria-hidden=true href=#workflow>#</a></h2><p><img loading=lazy src=https://about.gitlab.com/images/gitlab-flow/gitlab-flow.svg alt></p><blockquote><p><a href=https://about.gitlab.com/images/gitlab-flow/gitlab-flow.svg>https://about.gitlab.com/images/gitlab-flow/gitlab-flow.svg</a></p></blockquote><hr><p>Gitlab flow 就與 Git flow 有差別了，想知道更多可以看這部影片<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/7lgGEXpsflI?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div></p><h2 id=gitlab-ci-實作>GitLab CI 實作<a hidden class=anchor aria-hidden=true href=#gitlab-ci-實作>#</a></h2><p>這次用 Gitlab 主要是使用它的 <code>CI</code> 功能，不像 Github Actions 有很多套件可以選擇，反而需要自己寫 workflow 還有建製 runner</p><h3 id=名詞介紹>名詞介紹<a hidden class=anchor aria-hidden=true href=#名詞介紹>#</a></h3><p><img loading=lazy src=https://www.opengeosys.org/docs/devguide/testing/gitlab-ci/GitLab-Pipeline.png alt=demo></p><blockquote><p><a href=https://www.opengeosys.org/docs/devguide/testing/gitlab-ci/GitLab-Pipeline.png>https://www.opengeosys.org/docs/devguide/testing/gitlab-ci/GitLab-Pipeline.png</a></p></blockquote><h4 id=pipelines>Pipelines<a hidden class=anchor aria-hidden=true href=#pipelines>#</a></h4><p>上圖一整個畫面就是一個 <code>pipeline</code>，在 Gitlab 中的 pipeline 與 CPU pipeline 相似，目的都是讓程式能夠更快的執行完畢，在這裡是為了讓我們的 CI 各方便快速。</p><h4 id=stages>Stages<a hidden class=anchor aria-hidden=true href=#stages>#</a></h4><p>最上面那一列的粗體黑字就是 <code>stage</code>，代表這一個 pipeline 的各個階段，Gitlab 的官方文件有簡易的寫法，也可以自定義。</p><h4 id=jobs>Jobs<a hidden class=anchor aria-hidden=true href=#jobs>#</a></h4><p>stage 裡面每一個方框就是 <code>job</code>，代表它的工作，實際上要做什麼事都在裡面定義</p><h4 id=runners>Runners<a hidden class=anchor aria-hidden=true href=#runners>#</a></h4><p>這些 jobs 需要架機器在上面跑，這時候就需要 <code>runner</code></p><ul><li>在 Gitlab 中分成這三種：<ul><li>shared runner</li><li>group runner</li><li>project runner</li></ul></li></ul><h3 id=gitlab-ciyml>.gitlab-ci.yml<a hidden class=anchor aria-hidden=true href=#gitlab-ciyml>#</a></h3><p>上述說到 Gitlab CI 非常的客製化，可以自定義 pipeline，而這些檔案就需要寫在 <code>.gitlab-ci.yml</code></p><blockquote><ol><li><code>.</code> 指在目錄中預設隱藏（不會顯示），與 <code>.gitignore</code> 一樣</li><li><code>gitlab-ci</code> 是 Gitlab 的預設檔名，會自動加入 pipeline</li><li><code>yml</code> 是一種標籤語言（YAML Ain&rsquo;t a Markup Language），常用來記錄設定檔（configuration）</li></ol></blockquote><p>這是官方文件的設定檔範例<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>build</span><span style=color:#f92672>-</span><span style=color:#a6e22e>job</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stage</span>: <span style=color:#a6e22e>build</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>script</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;Hello, $GITLAB_USER_LOGIN!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span><span style=color:#f92672>-</span><span style=color:#a6e22e>job1</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stage</span>: <span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>script</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;This job tests something&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>test</span><span style=color:#f92672>-</span><span style=color:#a6e22e>job2</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stage</span>: <span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>script</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;This job tests something, but takes more time than test-job1.&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;After the echo commands complete, it runs the sleep command for 20 seconds&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;which simulates a test that runs 20 seconds longer than test-job1&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>sleep</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>deploy</span><span style=color:#f92672>-</span><span style=color:#a6e22e>prod</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stage</span>: <span style=color:#a6e22e>deploy</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>script</span>:
</span></span><span style=display:flex><span>		<span style=color:#f92672>-</span> <span style=color:#a6e22e>echo</span> <span style=color:#e6db74>&#34;This job deploys something from the $CI_COMMIT_BRANCH branch.&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>environment</span>: <span style=color:#a6e22e>production</span></span></span></code></pre></td></tr></table></div></div></p><p>一般來說會有以下 <code>stages</code>：</p><ul><li>build</li><li>test</li><li>staging</li><li>production</li></ul><ol><li><code>stages</code> 標籤是記錄各種階段，對應到每個 job 裡面的 <code>stage</code>（line 2, 7, 12, 20）</li><li><code>jobs</code> 的名稱沒有硬性規定，就像變數命名一樣（line 1, 6, 11, 19）</li><li><code>script</code> 就跟 <code>shell script</code> 很像，可以執行一些指令（line 3, 8, 13, 21）</li></ol><blockquote><p>官方文件還有很多<a href=https://docs.gitlab.com/ee/ci/yaml/index.html>關鍵字</a>參考</p></blockquote><h3 id=assigned-runner>Assigned Runner<a hidden class=anchor aria-hidden=true href=#assigned-runner>#</a></h3><p>寫完設定檔之後，再來就要架設 runner，規則大概如下：</p><h4 id=新建-runner>新建 runner<a hidden class=anchor aria-hidden=true href=#新建-runner>#</a></h4><p>在 project 裡面點進 <code>Settings</code> > <code>CI/CD</code> > <code>Runners</code> > 點進 <code>Expand</code>
<img loading=lazy src=/images/gitlab_runners.png alt=demo></p><p>左右邊分成兩種 runner：</p><ul><li>project runner</li><li>shared runner (credit card validate)</li></ul><blockquote><p>第二種 shared runner 是官方提供的 runner，但是需要信用卡認證（不用錢），但自己還是有疑慮就沒試了</p></blockquote><p>點進 project runners > new project runner
<img loading=lazy src=/images/gitlab_add_new_runner.png alt=demo></p><p>填寫 <code>Operating System</code>、<code>Tags</code>、<code>Details</code>，就可以 <code>Create runner</code> 了</p><blockquote><p>在 <code>Tags</code> 下有一個 checkbox 建議勾選（當初沒勾選卡了很久）</p></blockquote><h4 id=安裝-gitlab-runner>安裝 gitlab-runner<a hidden class=anchor aria-hidden=true href=#安裝-gitlab-runner>#</a></h4><p>在註冊 runner 前，需要在自己的機器上建立環境，分成兩種：</p><ul><li>local runner （很麻煩）</li><li>docker （推薦用這個）</li></ul><p>安裝記錄就不寫了，放幾個當時遇到問題的圖片以及 references：
<img loading=lazy src=/images/gitlab_enable_runner.png alt=demo>
<img loading=lazy src=/images/gitlab_restart_runner.png alt=demo>
<img loading=lazy src=/images/gitlab_runner_install.png alt=demo></p><ul><li><a href=https://stackoverflow.com/questions/37187899/change-gitlab-ci-runner-user>Change Gitlab CI Runner user</a></li><li><a href=https://docs.gitlab.com/runner/register/index.html#docker>Registering runners</a></li></ul><blockquote><p>主要是權限環境問題，所以很推薦直接用 docker 建立虛擬環境，會它的基本指令直接照文件下就好了</p></blockquote><h4 id=註冊-runner>註冊 runner<a hidden class=anchor aria-hidden=true href=#註冊-runner>#</a></h4><p>建立完 runner 後再來就是 <code>register</code>，這步驟就像是你的 repo 與你電腦裡的 runner 連接</p><p><img loading=lazy src=/images/gitlab_runner_register.png alt=demo></p><blockquote><p>紅色部分為 token，每個 runner 的 token 都是唯一的</p></blockquote><p>接著照著下指令寫 runner 的設定檔（<code>config.toml</code>）：</p><ul><li>INSTANCE URL （你的 repo 的前綴網址）<blockquote><p>詳情看<a href=https://stackoverflow.com/questions/58236175/what-is-a-gitlab-instance-url-and-how-can-i-get-it>這裡</a></p></blockquote></li><li>token</li><li>name (Description)</li><li>executor<blockquote><p>它有很多種可以選，如果 runner 架在 local，想直接跑 <code>.gitlab-ci.yml</code> 選擇 <code>shell</code> 就好；用 docker 架設的話就選 <code>docker</code></p></blockquote></li></ul><p>這個設定檔預設放在 <code>/etc/gitlab-runner</code>
<img loading=lazy src=/images/gitlab_runner_config.png alt=demo></p><blockquote><p>因為每建一個 runner 都要再設定一次 config，也不可能改 config 位置，所以用 docker 建 runner 真的很方便</p></blockquote><h4 id=執行-runner>執行 runner<a hidden class=anchor aria-hidden=true href=#執行-runner>#</a></h4><p>再來就是 run runner 了</p><ul><li><p>local 端就下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gitlab-runner run
</span></span></code></pre></div></li><li><p>docker 就用 <code>image</code> 建立實例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run --rm -it -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register
</span></span></code></pre></div></li></ul><h3 id=結果>結果<a hidden class=anchor aria-hidden=true href=#結果>#</a></h3><p>到 Project 裡的 <code>Build</code> > <code>Pipelines</code>，可以看到這個 pipeline 的運行結果
<img loading=lazy src=/images/gitlab_pipelines.png alt=demo></p><blockquote><p>如果看到左邊的 Status 一直在 <code>pending</code> 可能是你的 runner 沒打開</p></blockquote><hr><h2 id=心得>心得<a hidden class=anchor aria-hidden=true href=#心得>#</a></h2><p>Gitlab CI 的自由度好高，感覺可以把很多後續維護的步驟全部自動化。而且後來研究過程中才發現我用過 <code>Github Actions</code> 它也是 CI 的一種，我這個部落格的架設就是利用它！</p><p>因為我的 code 沒有太龐大，所以沒有寫到 auto test，只有簡單的 echo，希望之後可以學到更多～</p><h2 id=相關連結>相關連結<a hidden class=anchor aria-hidden=true href=#相關連結>#</a></h2><ul><li><a href=https://gitlab.com/steven.ye1132024/hello-world>Gitlab Project - Steven Ye / Hello World</a></li><li><a href=https://github.com/qaz5823091/qaz5823091.github.io/actions/workflows/pages/pages-build-deployment>Github Actions - qaz5823091.github.io</a></li></ul><h2 id=參考>參考<a hidden class=anchor aria-hidden=true href=#參考>#</a></h2><ul><li><a href=https://developer.android.com/training/testing/local-tests>Build local unit tests</a></li><li><a href=https://developer.android.com/training/testing/instrumented-tests>Build instrumented tests</a></li><li><a href="https://www.youtube.com/watch?v=ljth1Q5oJoo&amp;t=2s">Continuous Integration with GitLab (overview demo)</a></li><li><a href=https://docs.gitlab.com/runner/>GitLab Runner</a></li><li><a href=https://docs.gitlab.com/runner/>Install GitLab Runner</a></li><li><a href=https://ithelp.ithome.com.tw/articles/10218938>架設 GitLab CI Runner</a></li><li><a href="https://www.youtube.com/watch?v=7lgGEXpsflI">What Is GitLab Workflow | GitLab Flow | GitLab Tutorial For Beginners | Part III</a></li><li><a href=https://marsping.gitlab.io/GitLabCICD/section1/>別怕！.gitlab-ci.yml 勇敢寫下去！</a></li><li><a href=https://docs.gitlab.com/ee/ci/yaml/index.html>.gitlab-ci.yml keyword reference</a></li><li><a href=https://sean22492249.medium.com/gitlab-ci-cd-%E4%BB%8B%E7%B4%B9%E8%88%87-runner-%E7%9A%84%E6%9E%B6%E8%A8%AD-afdbde9f22aa>Gitlab CI/CD 介紹與 Runner 的架設</a></li><li><a href=https://docs.gitlab.com/ee/ci/pipelines/>CI/CD pipelines</a></li><li><a href=https://linyencheng.github.io/2022/05/30/devops-gitlab-ci-and-gitlab-runner/>https://linyencheng.github.io/2022/05/30/devops-gitlab-ci-and-gitlab-runner/</a></li><li><a href=https://docs.gitlab.com/ee/ci/quick_start/>Tutorial: Create and run your first GitLab CI/CD pipeline</a></li><li><a href=https://stackoverflow.com/questions/58236175/what-is-a-gitlab-instance-url-and-how-can-i-get-it>Gitlab instance URL</a></li><li><a href=https://juejin.cn/post/6844903661328400397>Android GitLab CI + Docker 工程实践</a></li><li><a href=https://stackoverflow.com/questions/37187899/change-gitlab-ci-runner-user>Change Gitlab CI Runner user</a></li><li><a href=https://stackoverflow.com/questions/34625885/gitlab-ci-builds-remains-pending>Pipelines jobs without tag</a></li><li><a href=https://docs.gitlab.com/runner/register/index.html#docker>Registering runners Docker part</a></li><li><a href=https://docs.gitlab.com/runner/install/docker.html>Run GitLab Runner in a container</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/kdan/>Kdan</a></li><li><a href=http://localhost:1313/tags/android/>Android</a></li><li><a href=http://localhost:1313/tags/gitlab/>Gitlab</a></li><li><a href=http://localhost:1313/tags/ci/cd/>CI/CD</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/2024-01-27-test-github-actions-update/><span class=title>« Prev</span><br><span>[測試] Github Actions Update</span>
</a><a class=next href=http://localhost:1313/posts/2023-06-08-ncyu-assemblylanguage-final-exam/><span class=title>Next »</span><br><span>[期末] AssemblyLanguage Final Exam</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on x" href="https://x.com/intent/tweet/?text=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f&amp;hashtags=Kdan%2cAndroid%2cGitlab%2cCI%2fCD"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f&amp;title=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD&amp;summary=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f&title=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on whatsapp" href="https://api.whatsapp.com/send?text=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on telegram" href="https://telegram.me/share/url?text=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [練習] GitLab CI/CD on ycombinator" href="https://news.ycombinator.com/submitlink?t=%5b%e7%b7%b4%e7%bf%92%5d%20GitLab%20CI%2fCD&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2023-08-29-kdan-gitlab-ci-cd%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>羲加加的部落格</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script type=module>
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  
  

  
  
  const firebaseConfig = {
    apiKey: "AIzaSyDz4wfgVQ23o5OVXHYnYazZiR7kNcyIcjo",
    authDomain: "github-page-3f77c.firebaseapp.com",
    projectId: "github-page-3f77c",
    storageBucket: "github-page-3f77c.appspot.com",
    messagingSenderId: "305044408401",
    appId: "1:305044408401:web:c369fa0d11a33a73a3d070",
    measurementId: "G-KHPWTNHWRL"
  };

  
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script></body></html>